name: Build Images

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version (e.g., 0.3.1)'
        required: true
        default: '0.3.1'

jobs:
  build-image-x86_64:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git \
            mkosi \
            systemd-container \
            qemu-img \
            xz

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set file permissions
        run: |
          chmod 755 mkosi-extra/usr/local/bin/*.sh
          chmod 600 mkosi-extra/etc/doas.conf

      - name: Build image
        run: mkosi --force --profile=x86_64 --image-version=${{ github.event.inputs.version }}

      - name: Convert and compress images
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          cd output
          mv *.raw arexibo-kiosk_${VERSION}_x86_64.raw
          qemu-img convert -f raw -O qcow2 -c arexibo-kiosk_${VERSION}_x86_64.raw arexibo-kiosk_${VERSION}_x86_64.qcow2
          qemu-img resize arexibo-kiosk_${VERSION}_x86_64.qcow2 16G
          xz -T0 -9 arexibo-kiosk_${VERSION}_x86_64.raw

      - name: List output
        run: ls -lah output/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: images-x86_64
          path: |
            output/*.qcow2
            output/*.raw.xz
          retention-days: 30

  build-image-aarch64:
    runs-on: ubuntu-24.04-arm
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            git \
            mkosi \
            systemd-container \
            xz

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set file permissions
        run: |
          chmod 755 mkosi-extra/usr/local/bin/*.sh
          chmod 600 mkosi-extra/etc/doas.conf

      - name: Build image
        run: mkosi --force --profile=aarch64 --image-version=${{ github.event.inputs.version }}

      - name: Rename with arch
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          cd output
          mv arexibo-kiosk_${VERSION}.raw arexibo-kiosk_${VERSION}_aarch64.raw

      - name: Compress image
        run: |
          cd output
          xz -T0 -9 arexibo-kiosk_${{ github.event.inputs.version }}_aarch64.raw

      - name: List output
        run: ls -lah output/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: images-aarch64
          path: output/*.raw.xz
          retention-days: 30

  build-installer-iso:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
      options: --privileged

    steps:
      - name: Install dependencies
        run: dnf install -y lorax pykickstart curl

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Fedora netinstall ISO
        run: |
          curl -L -o /tmp/fedora-netinst.iso \
            "https://ftp.plusline.net/fedora/linux/releases/43/Everything/x86_64/iso/Fedora-Everything-netinst-x86_64-43-1.6.iso"

      - name: Build installer ISO
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          mkksiso --skip-mkefiboot --ks kickstart/arexibo-kiosk.ks \
            /tmp/fedora-netinst.iso \
            arexibo-kiosk-installer_${VERSION}_x86_64.iso

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer-iso
          path: "*.iso"
          retention-days: 30

  release:
    needs: [build-image-x86_64, build-image-aarch64, build-installer-iso]
    runs-on: ubuntu-latest

    steps:
      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: images-*
          merge-multiple: true

      - name: Download installer ISO
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          name: installer-iso

      - name: Download RPMs from latest rpm.yml run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=$(gh run list -R "${{ github.repository }}" -w rpm.yml -s success -L1 --json databaseId -q '.[0].databaseId')
          if [ -z "$RUN_ID" ]; then
            echo "ERROR: No successful rpm.yml run found"
            exit 1
          fi
          echo "Downloading RPMs from run $RUN_ID"
          gh run download "$RUN_ID" -R "${{ github.repository }}" -p 'rpms-*' -D artifacts/

      - name: Flatten files
        run: |
          mkdir -p release
          find artifacts -name "*.rpm" -exec mv {} release/ \;
          find artifacts -name "*.qcow2" -exec mv {} release/ \;
          find artifacts -name "*.raw.xz" -exec mv {} release/ \;
          find artifacts -name "*.iso" -exec mv {} release/ \;
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          files: release/*
          draft: false
          prerelease: false
          body: |
            ## Arexibo Kiosk v${{ github.event.inputs.version }}

            ### Installation Methods

            #### 1. Installer ISO (Recommended for physical hardware)

            Boot from USB and install automatically:

            ```bash
            # Flash ISO to USB
            sudo dd if=arexibo-kiosk-installer_*_x86_64.iso of=/dev/sdX bs=8M status=progress
            ```

            Or use a stock Fedora netinstall ISO with kickstart URL:
            ```
            # At boot, press 'e' and add to kernel cmdline:
            inst.ks=https://raw.githubusercontent.com/linuxnow/arexibo/master/kickstart/arexibo-kiosk.ks
            ```

            #### 2. Disk Images (Flash directly)

            - **Raw.xz** (x86_64 / aarch64): For Balena Etcher or dd

            ```bash
            xz -dc arexibo-kiosk_*_x86_64.raw.xz | sudo dd of=/dev/sdX bs=8M status=progress
            ```

            #### 3. VM Image

            - **QCOW2** (x86_64): For GNOME Boxes, virt-manager, QEMU

            ```bash
            qemu-system-x86_64 -enable-kvm -m 2G -drive file=arexibo-kiosk_*_x86_64.qcow2
            ```

            #### 4. RPM Installation (existing Fedora 43)

            ```bash
            # Import GPG key for package verification
            sudo rpm --import https://linuxnow.github.io/arexibo/rpm/RPM-GPG-KEY-arexibo

            # Add repository
            sudo tee /etc/yum.repos.d/arexibo.repo <<'EOF'
            [arexibo]
            name=Arexibo
            baseurl=https://linuxnow.github.io/arexibo/rpm/fedora/43/$basearch/
            enabled=1
            gpgcheck=1
            gpgkey=https://linuxnow.github.io/arexibo/rpm/RPM-GPG-KEY-arexibo
            EOF

            # Install
            sudo dnf install arexibo arexibo-kiosk
            ```

            ### Default Credentials

            - `xibo` / `xibo` (kiosk user)
            - `root` / `root` (locked by default on installer ISO)

            ⚠️ **Change passwords after first login!**

            After booting, a setup wizard will configure your Xibo CMS connection.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
