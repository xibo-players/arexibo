name: Build DEBs

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.3.1 or 0.3.1-2)'
        required: false
        default: '0.3.1'

jobs:
  build-deb-x86_64:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:24.04
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      release: ${{ steps.version.outputs.RELEASE }}
      tag: ${{ steps.version.outputs.TAG }}

    steps:
      - name: Install build dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y \
            git \
            build-essential \
            cargo \
            cmake \
            g++ \
            libdbus-1-dev \
            libzmq3-dev \
            qt6-webengine-dev \
            debhelper \
            devscripts \
            dpkg-dev \
            dpkg-sig

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-x86_64-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            cargo-x86_64-

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            TAG="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/v}"
          else
            TAG="0.3.1"
          fi
          echo "VERSION=${TAG%%-*}" >> $GITHUB_OUTPUT
          if [[ "$TAG" == *-* ]]; then
            echo "RELEASE=${TAG#*-}" >> $GITHUB_OUTPUT
          else
            echo "RELEASE=1" >> $GITHUB_OUTPUT
          fi
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT

      - name: Build Rust binary
        run: cargo build --release
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"

      - name: Create DEB package directories
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          mkdir -p deb-pkg/arexibo/DEBIAN
          mkdir -p deb-pkg/arexibo/usr/bin
          mkdir -p deb-pkg/arexibo/usr/share/doc/arexibo
          
          mkdir -p deb-pkg/xibo-kiosk/DEBIAN
          mkdir -p deb-pkg/xibo-kiosk/usr/share/xibo-kiosk
          mkdir -p deb-pkg/xibo-kiosk/usr/lib/systemd/user
          mkdir -p deb-pkg/xibo-kiosk/etc/keyd

      - name: Install files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          
          # Main package
          install -m755 target/release/arexibo deb-pkg/arexibo/usr/bin/arexibo
          install -m644 LICENSE deb-pkg/arexibo/usr/share/doc/arexibo/
          install -m644 README.md deb-pkg/arexibo/usr/share/doc/arexibo/
          install -m644 CHANGELOG.md deb-pkg/arexibo/usr/share/doc/arexibo/
          
          # Kiosk package
          install -m755 kiosk/gnome-kiosk-script.xibo.sh deb-pkg/xibo-kiosk/usr/share/xibo-kiosk/
          install -m755 kiosk/gnome-kiosk-script.xibo-init.sh deb-pkg/xibo-kiosk/usr/share/xibo-kiosk/
          install -m644 kiosk/dunstrc deb-pkg/xibo-kiosk/usr/share/xibo-kiosk/
          install -m644 kiosk/xibo-player.service deb-pkg/xibo-kiosk/usr/lib/systemd/user/
          install -m755 kiosk/xibo-keyd-run.sh deb-pkg/xibo-kiosk/usr/share/xibo-kiosk/
          install -m755 kiosk/xibo-show-ip.sh deb-pkg/xibo-kiosk/usr/share/xibo-kiosk/
          install -m755 kiosk/xibo-show-cms.sh deb-pkg/xibo-kiosk/usr/share/xibo-kiosk/
          install -m644 kiosk/keyd-xibo.conf deb-pkg/xibo-kiosk/etc/keyd/xibo.conf

      - name: Create control files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          ARCH="amd64"
          
          # Main package control
          cat > deb-pkg/arexibo/DEBIAN/control << EOF
          Package: arexibo
          Version: ${VERSION}-${RELEASE}
          Section: misc
          Priority: optional
          Architecture: ${ARCH}
          Depends: libqt6webenginecore6, libqt6webenginewidgets6, libdbus-1-3, libzmq5
          Maintainer: Pau Aliagas <pau@linuxnow.com>
          Description: Rust-based digital signage player for Xibo CMS
           Arexibo is a Rust-based digital signage player compatible with Xibo CMS.
           It provides a lightweight alternative to the official Xibo player,
           designed for kiosk and digital signage deployments on Linux.
          Homepage: https://github.com/linuxnow/arexibo
          EOF
          
          # Kiosk package control
          cat > deb-pkg/xibo-kiosk/DEBIAN/control << EOF
          Package: xibo-kiosk
          Version: ${VERSION}-${RELEASE}
          Section: misc
          Priority: optional
          Architecture: all
          Depends: arexibo (= ${VERSION}-${RELEASE}), gnome-kiosk-script-session, dunst, unclutter, zenity, doas, keyd, mesa-va-drivers, va-driver-all
          Maintainer: Pau Aliagas <pau@linuxnow.com>
          Description: Kiosk session scripts for Arexibo
           Kiosk session scripts for running Arexibo as a full-screen digital signage
           player under GNOME Kiosk. Includes a first-boot registration wizard,
           session holder with health monitoring, dunst notification config, and
           a systemd user unit for the player process.
          Homepage: https://github.com/linuxnow/arexibo
          EOF

      - name: Build DEB packages
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          
          dpkg-deb --build deb-pkg/arexibo arexibo_${VERSION}-${RELEASE}_amd64.deb
          dpkg-deb --build deb-pkg/xibo-kiosk xibo-kiosk_${VERSION}-${RELEASE}_all.deb
          
          ls -lh *.deb

      - name: Upload DEB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debs-x86_64
          path: "*.deb"
          retention-days: 30

  build-deb-aarch64:
    runs-on: ubuntu-24.04-arm
    container:
      image: ubuntu:24.04
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      release: ${{ steps.version.outputs.RELEASE }}
      tag: ${{ steps.version.outputs.TAG }}

    steps:
      - name: Install build dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y \
            git \
            build-essential \
            cargo \
            cmake \
            g++ \
            libdbus-1-dev \
            libzmq3-dev \
            qt6-webengine-dev \
            debhelper \
            devscripts \
            dpkg-dev \
            dpkg-sig

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Cargo registry and target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-aarch64-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml') }}
          restore-keys: |
            cargo-aarch64-

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            TAG="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${GITHUB_REF#refs/tags/v}"
          else
            TAG="0.3.1"
          fi
          echo "VERSION=${TAG%%-*}" >> $GITHUB_OUTPUT
          if [[ "$TAG" == *-* ]]; then
            echo "RELEASE=${TAG#*-}" >> $GITHUB_OUTPUT
          else
            echo "RELEASE=1" >> $GITHUB_OUTPUT
          fi
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT

      - name: Build Rust binary
        run: cargo build --release
        env:
          CARGO_NET_GIT_FETCH_WITH_CLI: "true"

      - name: Create DEB package directories
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          mkdir -p deb-pkg/arexibo/DEBIAN
          mkdir -p deb-pkg/arexibo/usr/bin
          mkdir -p deb-pkg/arexibo/usr/share/doc/arexibo

      - name: Install files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          
          # Main package only (kiosk package built in x86_64 job only)
          install -m755 target/release/arexibo deb-pkg/arexibo/usr/bin/arexibo
          install -m644 LICENSE deb-pkg/arexibo/usr/share/doc/arexibo/
          install -m644 README.md deb-pkg/arexibo/usr/share/doc/arexibo/
          install -m644 CHANGELOG.md deb-pkg/arexibo/usr/share/doc/arexibo/

      - name: Create control files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          ARCH="arm64"
          
          # Main package control
          cat > deb-pkg/arexibo/DEBIAN/control << EOF
          Package: arexibo
          Version: ${VERSION}-${RELEASE}
          Section: misc
          Priority: optional
          Architecture: ${ARCH}
          Depends: libqt6webenginecore6, libqt6webenginewidgets6, libdbus-1-3, libzmq5
          Maintainer: Pau Aliagas <pau@linuxnow.com>
          Description: Rust-based digital signage player for Xibo CMS
           Arexibo is a Rust-based digital signage player compatible with Xibo CMS.
           It provides a lightweight alternative to the official Xibo player,
           designed for kiosk and digital signage deployments on Linux.
          Homepage: https://github.com/linuxnow/arexibo
          EOF

      - name: Build DEB packages
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          RELEASE=${{ steps.version.outputs.RELEASE }}
          
          dpkg-deb --build deb-pkg/arexibo arexibo_${VERSION}-${RELEASE}_arm64.deb
          
          ls -lh *.deb

      - name: Upload DEB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debs-aarch64
          path: "*.deb"
          retention-days: 30

  publish-repo:
    needs: [build-deb-x86_64, build-deb-aarch64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download DEB artifacts
        uses: actions/download-artifact@v4
        with:
          path: debs
          pattern: debs-*
          merge-multiple: true

      - name: Flatten DEB directory
        run: |
          mkdir -p flat-debs
          find debs -name "*.deb" -exec mv {} flat-debs/ \;
          ls -la flat-debs/

      - name: Import GPG key and sign DEBs
        env:
          GPG_KEY: ${{ secrets.DEB_GPG_KEY }}
          GPG_PASSPHRASE: ${{ secrets.DEB_GPG_PASSPHRASE }}
        run: |
          sudo apt-get update && sudo apt-get install -y dpkg-sig

          # Import key
          echo "$GPG_KEY" | gpg --batch --import

          # Configure GPG for non-interactive use
          mkdir -p ~/.gnupg
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent

          # Get GPG key ID
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2)
          echo "Using GPG Key ID: $GPG_KEY_ID"

          # Sign all DEBs
          for deb in flat-debs/*.deb; do
            echo "$GPG_PASSPHRASE" | dpkg-sig --sign builder -k "$GPG_KEY_ID" --gpg-options "--batch --no-tty --pinentry-mode loopback --passphrase-fd 0" "$deb"
          done

          # Verify signatures
          dpkg-sig --verify flat-debs/*.deb || true

          # Export public key for repo
          gpg --export --armor "$GPG_KEY_ID" > flat-debs/DEB-GPG-KEY-arexibo

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1
        continue-on-error: true

      - name: Initialize gh-pages if needed
        run: |
          if [ ! -d gh-pages/.git ]; then
            mkdir -p gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
          fi

      - name: Publish DEBs to APT repository
        run: |
          mkdir -p gh-pages/deb/ubuntu/24.04/amd64
          mkdir -p gh-pages/deb/ubuntu/24.04/arm64

          # Copy GPG key
          cp flat-debs/DEB-GPG-KEY-arexibo gh-pages/deb/

          # Copy DEBs to appropriate architecture directories
          for deb in flat-debs/*.deb; do
            case "$deb" in
              *_amd64.deb) cp "$deb" gh-pages/deb/ubuntu/24.04/amd64/ ;;
              *_arm64.deb) cp "$deb" gh-pages/deb/ubuntu/24.04/arm64/ ;;
              *_all.deb) 
                cp "$deb" gh-pages/deb/ubuntu/24.04/amd64/
                cp "$deb" gh-pages/deb/ubuntu/24.04/arm64/ ;;
            esac
          done

      - name: Create APT repository metadata
        run: |
          cd gh-pages/deb/ubuntu/24.04

          # Get GPG key ID
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2)

          # Create Packages files for each architecture
          for arch in amd64 arm64; do
            cd $arch
            dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz
            dpkg-scanpackages . /dev/null > Packages
            cd ..
          done

          # Create Release file
          cat > Release << EOF
          Origin: arexibo
          Label: arexibo
          Suite: stable
          Codename: noble
          Architectures: amd64 arm64
          Components: .
          Description: Arexibo APT Repository
          Date: $(date -R -u)
          EOF

          # Add checksums to Release file
          echo "MD5Sum:" >> Release
          for arch in amd64 arm64; do
            for file in $arch/Packages $arch/Packages.gz; do
              if [ -f "$file" ]; then
                echo " $(md5sum $file | awk '{print $1}') $(stat -c%s $file) $file" >> Release
              fi
            done
          done

          echo "SHA1:" >> Release
          for arch in amd64 arm64; do
            for file in $arch/Packages $arch/Packages.gz; do
              if [ -f "$file" ]; then
                echo " $(sha1sum $file | awk '{print $1}') $(stat -c%s $file) $file" >> Release
              fi
            done
          done

          echo "SHA256:" >> Release
          for arch in amd64 arm64; do
            for file in $arch/Packages $arch/Packages.gz; do
              if [ -f "$file" ]; then
                echo " $(sha256sum $file | awk '{print $1}') $(stat -c%s $file) $file" >> Release
              fi
            done
          done

          # Sign Release file
          echo "${{ secrets.DEB_GPG_PASSPHRASE }}" | gpg --batch --no-tty --pinentry-mode loopback --passphrase-fd 0 --armor --detach-sign -o Release.gpg Release
          echo "${{ secrets.DEB_GPG_PASSPHRASE }}" | gpg --batch --no-tty --pinentry-mode loopback --passphrase-fd 0 --clearsign -o InRelease Release

          cd ../../../../
          ls -laR gh-pages/deb/

      - name: Push to gh-pages
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update DEB repository"
          # Pull with rebase to handle concurrent pushes
          git pull --rebase "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages || true
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
